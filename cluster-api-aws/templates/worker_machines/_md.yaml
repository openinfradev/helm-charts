{{- $envAll := . }}
{{- range .Values.machineDeployment }}
{{- $mdName := .name }}
{{- $numAZ := .numberOfAZ | int }}
{{- $minSizePerAZ := .minSizePerAZ }}
{{- $maxSizePerAZ := .maxSizePerAZ }}
{{- $mdSelector := .selector }}
{{- $mdMachineType := .machineType }}
{{- $mdRootVolumeSize := .rootVolume.size }}
{{- $mdRootVolumeType := .rootVolume.type }}
{{- $mdSubnet := .subnet }}
{{- $spot := .spotInstance }}
{{- range untilStep 0 $numAZ 1 }}
{{ $mdName }}-{{ . }}:
  MachineDeployment:
    apiVersion: {{ $envAll.Values.api.group.cluster }}/{{ $envAll.Values.api.version }}
    kind: MachineDeployment
    metadata:
      {{- if $envAll.Values.cluster.eksEnabled }}
      name: {{ $envAll.Values.cluster.name }}-eks-md-{{ $mdName }}-{{ . }}
      {{- else }}
      name: {{ $envAll.Values.cluster.name }}-md-{{ $mdName }}-{{ . }}
      {{- end }}
      namespace: {{ $envAll.Release.Namespace }}
      annotations:
        cluster.x-k8s.io/cluster-api-autoscaler-node-group-min-size: "{{ $minSizePerAZ }}"
        cluster.x-k8s.io/cluster-api-autoscaler-node-group-max-size: "{{ $maxSizePerAZ }}"
    spec:
      clusterName: {{ $envAll.Values.cluster.name }}
      replicas: {{ $minSizePerAZ }}
      template:
        spec:
          bootstrap:
            configRef:
              apiVersion: {{ $envAll.Values.api.group.bootstrap }}/{{ $envAll.Values.api.version }}
              {{- if $envAll.Values.cluster.eksEnabled }}
              kind: EKSConfigTemplate
              name: {{ $envAll.Values.cluster.name }}-eks-md-{{ $mdName }}-{{ . }}
              {{- else }}
              kind: KubeadmConfigTemplate
              name: {{ $envAll.Values.cluster.name }}-md-{{ $mdName }}-{{ . }}
              {{- end }}
          clusterName: {{ $envAll.Values.cluster.name }}
          infrastructureRef:
            apiVersion: {{ $envAll.Values.api.group.infrastructure }}/{{ $envAll.Values.api.version }}
            kind: AWSMachineTemplate
            name: {{ $envAll.Values.cluster.name }}-md-{{ $mdName }}-{{ . }}
          version: {{ $envAll.Values.cluster.kubernetesVersion }}
      {{- with $mdSelector }}
      selector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
  AWSMachineTemplate:
    apiVersion: {{ $envAll.Values.api.group.infrastructure }}/{{ $envAll.Values.api.version }}
    kind: AWSMachineTemplate
    metadata:
      name: {{ $envAll.Values.cluster.name }}-md-{{ $mdName }}-{{ . }}
      namespace: {{ $envAll.Release.Namespace }}
    spec:
      template:
        spec:
          iamInstanceProfile: nodes.cluster-api-provider-aws.sigs.k8s.io
          instanceType: {{ $mdMachineType }}
          sshKeyName: {{ $envAll.Values.sshKeyName }}
          rootVolume:
            size: {{ $mdRootVolumeSize }}
            type: {{ $mdRootVolumeType }}
          {{- if $mdSubnet }}
          subnet:
            id: {{ $mdSubnet }}
          {{- end }}
          {{- if $spot.enabled }}
          spotMarketOptions:
            maxPrice: {{ $spot.maxPrice}}
          {{- end }}
  {{- if $envAll.Values.cluster.eksEnabled }}
  EKSConfigTemplate:
    apiVersion: {{ $envAll.Values.api.group.bootstrap }}/{{ $envAll.Values.api.version }}
    kind: EKSConfigTemplate                                                                                                               
    metadata:                                                                                                                             
      name: {{ $envAll.Values.cluster.name }}-eks-md-{{ $mdName }}-{{ . }}
      namespace: {{ $envAll.Release.Namespace }}
    spec: 
      template: {}
  {{- else }}
  KubeadmConfigTemplate:
    apiVersion: {{ $envAll.Values.api.group.bootstrap }}/{{ $envAll.Values.api.version }}
    kind: KubeadmConfigTemplate
    metadata:
      name: {{ $envAll.Values.cluster.name }}-md-{{ $mdName }}-{{ . }}
      namespace: {{ $envAll.Release.Namespace }}
    spec:
      template:
        spec:
          joinConfiguration:
            nodeRegistration:
              kubeletExtraArgs:
                cloud-provider: aws
              name: '{{`{{ ds.meta_data.local_hostname }}`}}'
  {{- end }}
{{- end }}
{{- end }}
